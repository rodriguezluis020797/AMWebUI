<!-- Loading Screen -->
<div *ngIf="loading" class="login-container">
  <am-loading-screen></am-loading-screen>
</div>

<!-- Profile Content -->
<div *ngIf="!loading">
  <div class="container py-4" style="max-width: 600px;">
    <h2 class="mb-4">{{ editProvider ? 'Edit Profile' : 'Your Profile' }}</h2>

    <!-- Error Message -->
    <div *ngIf="editDTO.errorMessage && editProvider" class="alert alert-danger">
      {{ editDTO.errorMessage }}
    </div>

    <!-- Display Mode -->
    <ng-container *ngIf="!editProvider; else editMode">
      <div class="mb-3"><strong>Business Name:</strong> {{ dto.businessName }}</div>
      <div class="mb-3"><strong>Description:</strong> {{ dto.description || '—' }}</div>

      <div class="mb-3"><strong>First Name:</strong> {{ dto.firstName }}</div>
      <div class="mb-3"><strong>Middle Name:</strong> {{ dto.middleName || '—' }}</div>
      <div class="mb-3"><strong>Last Name:</strong> {{ dto.lastName }}</div>
      <div class="mb-3"><strong>E-Mail:</strong> {{ dto.eMail }}</div>

      <div class="mb-3"><strong>Address Line 1:</strong> {{ dto.addressLine1 }}</div>
      <div class="mb-3"><strong>Address Line 2:</strong> {{ dto.addressLine2 || '—' }}</div>
      <div class="mb-3"><strong>City:</strong> {{ dto.city }}</div>
      <div class="mb-3"><strong>Zip Code:</strong> {{ dto.zipCode }}</div>

      <div class="mb-3"><strong>State:</strong> {{ getEnumLabel(StateCodeEnum, dto.stateCode) }}</div>
      <div class="mb-3"><strong>Country:</strong> {{ getEnumLabel(CountryCodeEnum, dto.countryCode) }}</div>
      <div class="mb-3"><strong>Time Zone:</strong> {{ getEnumLabel(TimeZoneCodeEnum, dto.timeZoneCode) }}</div>

      <div class="mb-3">
        <strong>Availability:</strong>
        <ul class="list-unstyled mb-0">
          <li *ngFor="let availability of dto.availabilities" class="border-bottom py-1 d-flex justify-content-between">
            <span>{{ availability.dayOfWeek | dayOfTheWeek }}</span>
            <span class="text-muted" [ngClass]="{ 'text-danger': !availability.available }">
              {{ availability.available ? (availability.startTime + ' – ' + availability.endTime) : 'Unavailable' }}
            </span>
          </li>
        </ul>
      </div>

      <div class="d-grid gap-2 mt-4">
        <button class="btn btn-primary" (click)="edit()">Edit</button>
        <a class="btn btn-outline-secondary" [href]="dto.payEngineInfoUrl" target="_blank">Payment & Invoices</a>
      </div>

      <div *ngIf="dto.accountStatus === AccountStatusEnum.Active" class="mt-4">
        <p><strong>Next Billing Date:</strong> {{ dto.nextBillingDate | date: 'MM/dd/yyyy' }}</p>
        <a role="button" class="text-danger" (click)="cancelSubscription()">Cancel Subscription</a>
      </div>

      <div *ngIf="dto.accountStatus !== AccountStatusEnum.Active" class="mt-4">
        <p *ngIf="dto.errorMessage" class="text-danger">{{ dto.errorMessage }}</p>
        <p><strong>Final Date of Service:</strong> {{ dto.nextBillingDate | date: 'MM/dd/yyyy' }}</p>
        <a role="button" (click)="reActivateSubscription()">Reactivate Service</a>
      </div>
    </ng-container>

    <!-- Edit Mode -->
    <ng-template #editMode>
      <form (ngSubmit)="editSave()" #profileForm="ngForm" novalidate>
        <div class="mb-3">
          <label for="businessName" class="form-label">Business Name</label>
          <input id="businessName" name="businessName" type="text" [(ngModel)]="editDTO.businessName"
            class="form-control" required placeholder="Business Name" />
        </div>

        <div class="mb-3">
          <label for="description" class="form-label">Business Description</label>
          <textarea id="description" name="description" [(ngModel)]="editDTO.description" rows="4" class="form-control"
            placeholder="Business Description"></textarea>
        </div>

        <div class="mb-3">
          <label for="firstName" class="form-label">First Name</label>
          <input id="firstName" name="firstName" type="text" [(ngModel)]="editDTO.firstName" class="form-control"
            required placeholder="First Name" />
        </div>

        <div class="mb-3">
          <label for="middleName" class="form-label">Middle Name</label>
          <input id="middleName" name="middleName" type="text" [(ngModel)]="editDTO.middleName" class="form-control"
            placeholder="Middle Name" />
        </div>

        <div class="mb-3">
          <label for="lastName" class="form-label">Last Name</label>
          <input id="lastName" name="lastName" type="text" [(ngModel)]="editDTO.lastName" class="form-control" required
            placeholder="Last Name" />
        </div>

        <div class="mb-3">
          <label for="addressLine1" class="form-label">Address Line 1</label>
          <input id="addressLine1" name="addressLine1" type="text" [(ngModel)]="editDTO.addressLine1"
            class="form-control" required placeholder="Address Line 1" />
        </div>

        <div class="mb-3">
          <label for="addressLine2" class="form-label">Address Line 2</label>
          <input id="addressLine2" name="addressLine2" type="text" [(ngModel)]="editDTO.addressLine2"
            class="form-control" placeholder="Address Line 2" />
        </div>

        <div class="mb-3">
          <label for="city" class="form-label">City</label>
          <input id="city" name="city" type="text" [(ngModel)]="editDTO.city" class="form-control" required
            placeholder="City" />
        </div>

        <div class="mb-3">
          <label for="zipCode" class="form-label">Zip Code</label>
          <input id="zipCode" name="zipCode" type="text" [(ngModel)]="editDTO.zipCode" class="form-control" required
            placeholder="Zip Code" />
        </div>

        <div class="mb-3">
          <label for="stateCode" class="form-label">State</label>
          <select id="stateCode" name="stateCode" [(ngModel)]="editDTO.stateCode" class="form-select" required>
            <option *ngFor="let opt of stateOptions" [ngValue]="opt.key">{{ getEditLabel(opt.label) }}</option>
          </select>
        </div>

        <div class="mb-3">
          <label for="timeZoneCode" class="form-label">Time Zone</label>
          <select id="timeZoneCode" name="timeZoneCode" [(ngModel)]="editDTO.timeZoneCode" class="form-select" required>
            <option *ngFor="let opt of timeZoneOptions" [ngValue]="opt.key">{{ opt.label }}</option>
          </select>
        </div>

        <!-- Availability -->
        <div class="mb-3">
          <label class="form-label">Availability</label>
          <div *ngFor="let day of daysOfWeek; let i = index" class="mb-2 p-2 border rounded">
            <div class="form-check form-switch">
              <input class="form-check-input" type="checkbox" id="available-{{ i }}"
                [(ngModel)]="editDTO.availabilities[i].available" name="available-{{ i }}" />
              <label class="form-check-label" for="available-{{ i }}">{{ dayNames[i] }}</label>
            </div>

            <div *ngIf="editDTO.availabilities[i].available" class="row mt-2">
              <div class="col">
                <label for="startTime-{{ i }}" class="form-label">Start Time</label>
                <input id="startTime-{{ i }}" name="startTime-{{ i }}" type="time" class="form-control"
                  [(ngModel)]="editDTO.availabilities[i].startTime" />
              </div>
              <div class="col">
                <label for="endTime-{{ i }}" class="form-label">End Time</label>
                <input id="endTime-{{ i }}" name="endTime-{{ i }}" type="time" class="form-control"
                  [(ngModel)]="editDTO.availabilities[i].endTime" />
              </div>
            </div>
          </div>
        </div>
        <div class="d-flex flex-wrap gap-3 mt-4">
          <button type="submit" [disabled]="profileForm.invalid || loading" class="btn btn-success">Save</button>
          <button type="button" class="btn btn-outline-secondary" (click)="cancelEdit()">Cancel</button>
        </div>
        <div class="d-flex flex-wrap gap-3 mt-4">
          <a routerLink="/reset-email" class="btn btn-link p-0">Update E-Mail</a>
          <a routerLink="/update-password" class="btn btn-link p-0">Update Password</a>
        </div>

      </form>
    </ng-template>
  </div>

  <!-- Modals -->
  <am-delete-entity *ngIf="showDeleteModal" [header]="'Cancel Subscription'"
    [message]="'You’ll keep access through your current billing period. Any messages set to go out afterward won’t be delivered unless you reactivate in time.'"
    (confirm)="onCancelSubscription($event)">
  </am-delete-entity>

  <am-delete-entity *ngIf="showReSubscribeModal" [header]="'Reactivate Subscription'"
    [message]="'Your subscription will be reactivated right away. If your last billing cycle has ended, your default payment method will be charged automatically.'"
    (confirm)="onReActivateSubscription($event)">
  </am-delete-entity>
</div>
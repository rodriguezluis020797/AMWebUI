<div *ngIf="!loading" class="appointment-container">
    <h1 *ngIf="!editAppointmentBool">Appointments</h1>
    <h1 *ngIf="editAppointmentBool">{{ isNewAppointment ? 'Add Appointment' : 'Edit Appointment' }}</h1>

    <!-- Error Display -->
    <div *ngIf="editDTO?.errorMessage && editAppointmentBool" class="error-message">
        <p>{{ editDTO.errorMessage }}</p>
    </div>

    <!-- List Mode -->
    <div *ngIf="!editAppointmentBool">
        <div *ngIf="appointments.length <= 0">
            <h2>You have no appointments.</h2>
        </div>
        <div *ngIf="0 < appointments.length">
            <div *ngFor="let appt of appointments" class="appointment-item">
                <h3>{{ appt.startDate | date:'M/d/yy h:mm a' }} - {{ appt.endDate | date:'h:mm a' }}</h3>
                <p><strong>Client:</strong> {{ appt.clientName }}</p>
                <p><strong>Service:</strong> {{ appt.serviceName }}</p>
                <p><strong>Notes:</strong> {{ appt.notes || '—' }}</p>
                <p><strong>Status:</strong> {{ appt.status | appointmentStatus }}</p>
                <button (click)="editAppointment(appt.appointmentId)">Edit</button>
            </div>
        </div>

        <button (click)="addAppointment()">Add New Appointment</button>
    </div>

    <!-- Edit/Add Mode -->
    <div *ngIf="editAppointmentBool">
        <label for="clientId">Client</label>
        <select *ngIf="isNewAppointment" id="clientId" [(ngModel)]="editDTO.clientId">
            <option *ngFor="let client of clients" [value]="client.clientId">
                {{ client.firstName }} {{client.middleName || ""}} {{ client.lastName }}
            </option>
        </select>
        <p *ngIf="!isNewAppointment">{{clientName}}</p>

        <label for="serviceId">Service</label>
        <select *ngIf="editDTO.status !== (AppointmentStatusEnum.Cancelled && AppointmentStatusEnum.Completed)"
            id="serviceId" (change)="onServiceChange()" [(ngModel)]="editDTO.serviceId">
            <option *ngFor="let service of services" [ngValue]="service.serviceId">
                {{ service.name }}
            </option>
        </select>

        <p *ngIf="editDTO.status === (AppointmentStatusEnum.Cancelled && AppointmentStatusEnum.Completed)">
            {{selectedServiceName}}
        </p>

        <label for="startDate">Start Date</label>
        <input *ngIf="editDTO.status !== (AppointmentStatusEnum.Cancelled && AppointmentStatusEnum.Completed)"
            type="datetime-local" id="startDate" [(ngModel)]="editDTO.startDate" step="900" />
        <p *ngIf="editDTO.status === (AppointmentStatusEnum.Cancelled && AppointmentStatusEnum.Completed)">
            {{ editDTO.startDate | date: 'M/d/yy h:mm a' }} </p>

        <label for="endDate">End Date</label>
        <input *ngIf="editDTO.status !== (AppointmentStatusEnum.Cancelled && AppointmentStatusEnum.Completed)"
            type="datetime-local" id="endDate" [(ngModel)]="editDTO.endDate" step="900" />

        <p *ngIf="editDTO.status === (AppointmentStatusEnum.Cancelled && AppointmentStatusEnum.Completed)">
            {{ editDTO.endDate | date: 'M/d/yy h:mm a' }} </p>

        <label for="notes">Notes</label>
        <textarea *ngIf="editDTO.status !== (AppointmentStatusEnum.Cancelled && AppointmentStatusEnum.Completed)"
            id="notes" [(ngModel)]="editDTO.notes"></textarea>
        <p *ngIf="editDTO.status === (AppointmentStatusEnum.Cancelled && AppointmentStatusEnum.Completed)">
            {{ editDTO.notes ? editDTO.notes : '—' }}</p>

        <label *ngIf="editDTO.status !== (AppointmentStatusEnum.Cancelled && AppointmentStatusEnum.Completed)"
            for="overridePrice">Override Price</label>
        <input *ngIf="editDTO.status !== (AppointmentStatusEnum.Cancelled && AppointmentStatusEnum.Completed)"
            type="checkbox" [(ngModel)]="editDTO.overridePrice" />

        <label for="price">Price</label>
        <p *ngIf="!editDTO.overridePrice">{{editDTO.price| currency}}</p>
        <input *ngIf="editDTO.overridePrice" type="number" id="price" [(ngModel)]="editDTO.price" min="0" step="5.00" />

        <label for="status">Status</label>
        <select *ngIf="editDTO.status !== (AppointmentStatusEnum.Cancelled && AppointmentStatusEnum.Completed)"
            id="status" [(ngModel)]="editDTO.status">
            <option *ngFor="let status of [0,1,2,3]" [value]="status">
                {{ status | appointmentStatus }}
            </option>
        </select>
        <p *ngIf="editDTO.status === (AppointmentStatusEnum.Cancelled && AppointmentStatusEnum.Completed)">
            <strong>{{editDTO.status | appointmentStatus}}</strong>
        </p>

        <br />
        <button (click)="save()">Save</button>
        <button (click)="cancel()">Cancel</button>
        <button *ngIf="!isNewAppointment && editDTO.status === AppointmentStatusEnum.Cancelled"
            (click)="delete(editDTO.appointmentId)">
            Delete
        </button>
    </div>
</div>

<am-delete-entity *ngIf="showDeleteModal && !loading" [header]="'Delete Appointment'"
    [message]="'Are you sure you want to delete this appointment?'" (confirm)="onConfirmDelete($event)">
</am-delete-entity>

<div *ngIf="loading">
    <am-loading-screen></am-loading-screen>
</div>